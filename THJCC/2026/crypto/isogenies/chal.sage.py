

# This file was *autogenerated* from the file chal.sage
from sage.all_cmdline import *   # import sage library

_sage_const_13 = Integer(13); _sage_const_7 = Integer(7); _sage_const_2 = Integer(2); _sage_const_3 = Integer(3); _sage_const_1 = Integer(1); _sage_const_0 = Integer(0); _sage_const_6 = Integer(6); _sage_const_16 = Integer(16)
from sage.all import *
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad
import hashlib
import os

ea, eb = _sage_const_13 , _sage_const_7 

p = _sage_const_2 **ea * _sage_const_3 **eb - _sage_const_1 
K = GF(p**_sage_const_2 , modulus=x**_sage_const_2  + _sage_const_1 , names=('i',)); (i,) = K._first_ngens(1)

E0 = EllipticCurve(K, [_sage_const_0 , _sage_const_6 , _sage_const_0 , _sage_const_1 , _sage_const_0 ])

def get_isogeny_chain(E, l, e, secret):
    curr_E = E
    phis = []
    for i in range(e):
        P, Q = curr_E.torsion_basis(l**(e-i))
        kernel_pt = (P + secret * Q) * l**(e-i-_sage_const_1 )
        phi = curr_E.isogeny(kernel_pt)
        phis.append(phi)
        curr_E = phi.codomain()
    return curr_E, phis

def push_point(phi_list, P):
    curr_P = P
    for phi in phi_list:
        curr_P = phi(curr_P)
    return curr_P

sa = randint(_sage_const_0 , _sage_const_2 **ea - _sage_const_1 )
sb = randint(_sage_const_0 , _sage_const_3 **eb - _sage_const_1 )

Ea, phis_a = get_isogeny_chain(E0, _sage_const_2 , ea, sa)
Eab, phis_b = get_isogeny_chain(Ea, _sage_const_3 , eb, sb)

P_pub = E0.random_element()
P_priv = push_point(phis_b, push_point(phis_a, P_pub))

shared_x = P_priv.xy()[_sage_const_0 ]
key = hashlib.sha256(str(shared_x).encode()).digest()[:_sage_const_16 ]
iv = os.urandom(_sage_const_16 )
cipher = AES.new(key, AES.MODE_CBC, iv=iv)
flag = b"THJCC{r_u_isogenies_master_or_llm_player}"
ciphertext = iv + cipher.encrypt(pad(flag, _sage_const_16 ))

print(f"E0: {E0.a_invariants()}")
print(f"Eab: {Eab.a_invariants()}")
print(f"P_pub: {P_pub.xy()}")
print(f"ciphertext: {ciphertext.hex()}")

# Output~
'''
E0: (0, 6, 0, 1, 0)
Eab: (0, 6, 0, 7950991*i + 10978984, 3550535*i + 7497917)
P_pub: (333627*i + 6677601, 9046017*i + 6416946)
ciphertext: 41120f9a4e064b869fec4278a72c44a8c3dbc4a1c8d34029c3c97dbea37db1f807752a7639094f6e6b7890538e40329e960046e0764d19845ffe26da629f8f42
'''

