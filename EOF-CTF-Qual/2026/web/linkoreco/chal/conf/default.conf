fastcgi_cache_path /tmp/nginx_cache levels=1:2 keys_zone=my_fastcgi_cache:10m inactive=60m;
map $request_uri $is_static {
    default 0;
    "~*^/static/.*\.(svg|png|jpg|jpeg|css)$" 1;
}
server {
    listen 80;
    root /var/www/html;
    index index.php;

    location = / {
        rewrite ^ /index.php last;
    }

    location / {
        try_files $uri $uri/;
    }

    location ~ [^/]\.php(/|$) {
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        
        if (!-f $document_root$fastcgi_script_name) {
            return 404;
        }
        fastcgi_pass php:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param REMOTE_ADDR $http_x_real_ip;
        fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
        fastcgi_cache my_fastcgi_cache;
        fastcgi_cache_key "$scheme$request_method$request_uri";
        set $no_cache 1;
        
        if ($is_static) {
            set $no_cache 0;
        }
        fastcgi_cache_bypass $no_cache;
        fastcgi_no_cache $no_cache;
        
        fastcgi_ignore_headers Cache-Control Expires Set-Cookie;
        fastcgi_cache_valid 200 60s;
        add_header X-Cache-Status $upstream_cache_status;
        add_header X-Debug-Static-Match $is_static; 
    }
}
